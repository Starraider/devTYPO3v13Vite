<html xmlns:f="http://typo3.org/ns/TYPO3/CMS/Fluid/ViewHelpers" data-namespace-typo3-fluid="true">
{namespace v=FluidTYPO3\Vhs\ViewHelpers}

<div class="accordion" id="accordionInfo">
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                <v:l key="tx_leseohren.membership" />
            </button>
        </h2>
        <div id="collapseOne" class="accordion-collapse collapse" data-bs-parent="#accordionInfo">
            <div class="accordion-body">
                <f:if condition="{person.membershipType}">
                    <strong>
                        <v:l key="tx_leseohren_domain_model_person.membership_type" />:
                    </strong><br />
                    <v:l key="tx_leseohren.membershipType.{person.membershipType}" /><br />
                    <f:if condition="{person.memberorg}">
                        <strong>
                            <f:translate key="tx_leseohren_domain_model_person.memberorg" />:
                        </strong><br />
                        <span class="text-danger">{person.memberorg}</span><br />
                    </f:if>
                    <strong>
                        <v:l key="tx_leseohren_domain_model_person.membership_fee" />:
                    </strong><br />
                    {person.membershipFee} &euro;/Jahr<br />
                </f:if>

                <strong>
                    <v:l key="tx_leseohren.paymentMethod" />:
                </strong><br />
                <f:switch expression="{person.paymentMethod}">
                    <f:case value="0">
                        <v:l key="tx_leseohren.paymentMethod.0" />
                    </f:case>
                    <f:case value="1"><i class="bi bi-bank"></i>&nbsp;
                        <v:l key="tx_leseohren.paymentMethod.1" />
                    </f:case>
                    <f:case value="2"><i class="bi bi-currency-euro"></i>&nbsp;
                        <v:l key="tx_leseohren.paymentMethod.2" />
                    </f:case>
                    <f:case value="3"><i class="bi bi-paypal"></i>&nbsp;
                        <v:l key="tx_leseohren.paymentMethod.3" />
                    </f:case>
                    <f:defaultCase></f:defaultCase>
                </f:switch>
                </br>
                <strong>
                    <f:translate key="tx_leseohren_domain_model_person.mandatsreferenz" />:
                </strong><br />
                <f:if condition="{person.mandatsreferenz}">
                    <f:then>
                        {person.mandatsreferenz}
                    </f:then>
                    <f:else>
                        <f:if condition="{person.paymentMethod} == 1 OR {person.paymentMethod} == 3">
                            <span class="text-danger">Fehlt!</span>
                        </f:if>
                    </f:else>
                </f:if>
                </br>
                <f:if condition="{person.paymentMethod} == 1">
                    <f:then>
                        <strong>
                            <f:translate key="tx_leseohren_domain_model_person.iban" />:
                        </strong><br />
                        {person.iban}</br>
                        <strong>
                            <f:translate key="tx_leseohren_domain_model_person.swift" />:
                        </strong><br />
                        {person.swift}</br>
                        <strong>
                            <f:translate key="tx_leseohren_domain_model_person.bankname" />:
                        </strong><br />
                        {person.bankname}</br>
                        <strong>
                            <f:translate key="tx_leseohren_domain_model_person.account_owner" />:
                        </strong><br />
                        {person.accountOwner}</br>
                    </f:then>
                    <f:else if="{person.paymentMethod} == 3">
                        <strong>
                            <f:translate key="tx_leseohren_domain_model_person.paypal" />:
                        </strong><br /> {person.paypal}</br>
                    </f:else>
                </f:if>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseFuehrungszeugnis" aria-expanded="false"
                aria-controls="collapseFuehrungszeugnis">
                <f:translate key="tx_leseohren_domain_model_person.files" />
            </button>
        </h2>
        <div id="collapseFuehrungszeugnis" class="accordion-collapse collapse" data-bs-parent="#accordionInfo">
            <div class="accordion-body">
                <div class="container-fluid gx-0 px-0">
                    <!-- Führungszeugnis -->
                    <div class="row gx-0 py-1">
                        <div class="col-12">
                            <strong>
                                <f:translate key="tx_leseohren_domain_model_person.file_fuehrungszeugnis" />:
                            </strong>
                            <br />
                        </div>
                    </div>
                    <f:if condition="{person.fileFuehrungszeugnis}">
                        <div class="c-person__file-link">
                            <div class="row gx-0 py-1">
                                <div class="col-9">
                                    <a href="{person.fileFuehrungszeugnis.originalResource.publicUrl}" target="_blank">
                                        {person.fileFuehrungszeugnis.originalResource.name -> f:format.crop(maxCharacters: 20)}
                                    </a>
                                </div>
                                <div class="col-3 text-end">
                                    <button type="button" class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal"
                                        data-bs-target="#deleteFuehrungszeugnisModal">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row gx-0 py-1">
                                <div class="col-3 text-center fs-3">
                                    <f:if condition="{person.fuehrungszeugnisChecked}">
                                        <f:then>
                                            <i class="bi bi-shield-check text-success" aria-hidden="true"
                                                title="{f:translate(key: 'tx_leseohren.fuehrungszeugnis.checked')}"></i>
                                            <span class="visually-hidden">
                                                <f:translate key="tx_leseohren.fuehrungszeugnis.checked" />
                                            </span>
                                        </f:then>
                                        <f:else>
                                            <i class="bi bi-shield-exclamation text-danger" aria-hidden="true"
                                                title="{f:translate(key: 'tx_leseohren.fuehrungszeugnis.notchecked')}"></i>
                                            <span class="visually-hidden">
                                                <f:translate key="tx_leseohren.fuehrungszeugnis.notchecked" />
                                            </span>
                                        </f:else>
                                    </f:if>
                                </div>
                                <div class="col-6">
                                    <strong>
                                        <f:translate key="tx_leseohren.date" />:
                                    </strong>
                                    <f:if condition="{person.fuehrungszeugnisDate}">
                                        <f:then>
                                            {person.fuehrungszeugnisDate -> f:format.date(format: 'd.m.Y')}
                                        </f:then>
                                        <f:else>
                                            <span class="text-danger">k.A.</span>
                                        </f:else>
                                    </f:if>
                                </div>
                                <div class="col-3 text-end">
                                    <button type="button" class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal"
                                        data-bs-target="#editFuehrungszeugnisModal">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </f:if>

                    <f:if condition="!{person.fileFuehrungszeugnis}">
                        <div class="row gx-0 py-1">
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#uploadFuehrungszeugnisModal">
                                    <i class="bi bi-upload"></i>
                                </button>
                            </div>
                        </div>
                    </f:if>

                    <div class="row gx-0 py-1">
                        <div class="col-12">
                            <hr /><!-- Mandat -->
                            <strong>
                                <f:translate key="tx_leseohren_domain_model_person.file_mandat" />:
                            </strong>
                        </div>
                    </div>

                    <f:if condition="{person.fileMandat}">
                        <div class="row gx-0 py-1 c-person__file-link">
                            <div class="col-9">
                                <a href="{person.fileMandat.originalResource.publicUrl}" target="_blank">
                                    {person.fileMandat.originalResource.name -> f:format.crop(maxCharacters: 20)}
                                </a>
                            </div>
                            <div class="col-3 text-end">
                                <button type="button" class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal"
                                    data-bs-target="#deleteMandatModal">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </div>
                    </f:if>
                    <f:if condition="!{person.fileMandat}">
                        <div class="row gx-0 py-1">
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                    data-bs-target="#uploadMandatModal">
                                    <i class="bi bi-upload"></i>
                                </button>
                            </div>
                        </div>
                    </f:if>
                    <div class="row gx-0 py-1">
                        <div class="col-12">
                            <hr /><!-- Other files -->
                            <strong>
                                <f:translate key="tx_leseohren_domain_model_person.file_others" />
                            </strong>:
                        </div>
                    </div>

                    <f:if condition="{person.fileOthers}">
                        <div class="c-person__file-link">
                            <!-- List all other files -->
                            <f:for each="{person.fileOthers}" as="otherFile">
                                <div class="row gx-0 py-1">
                                    <div class="col-9">
                                        <a href="{otherFile.originalResource.publicUrl}" target="_blank">
                                            {otherFile.originalResource.name -> f:format.crop(maxCharacters: 20)}
                                        </a>
                                    </div>
                                    <div class="col-3 text-end">
                                        <button type="button" class="btn btn-primary btn-sm ms-2" data-bs-toggle="modal"
                                            data-bs-target="#deleteOtherFileModal" data-file-uid="{otherFile.uid}">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </f:for>
                        </div>
                    </f:if>
                    <div class="row gx-0 py-1">
                        <div class="col-3 offset-9 text-end">
                            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal"
                                data-bs-target="#uploadOtherFilesModal">
                                <i class="bi bi-upload"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="accordion-item">
        <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                data-bs-target="#collapseThree" aria-expanded="false" aria-controls="collapseThree">
                Präferenzen
            </button>
        </h2>
        <div id="collapseThree" class="accordion-collapse collapse" data-bs-parent="#accordionInfo">
            <div class="accordion-body">
                <div class="c-person__travelOptions">
                    <strong>
                        <v:l key="tx_leseohren.travelOptions" />:
                    </strong> <br />
                    <f:switch expression="{person.travelOptions}">
                        <f:case value="0"><i class="bi bi-car-front"></i>&nbsp;
                            <v:l key="tx_leseohren.travelOptions.0" />
                        </f:case>
                        <f:case value="1">
                            <v:l key="tx_leseohren.travelOptions.1" />
                        </f:case>
                        <f:case value="2"><i class="bi bi-bus-front"></i>&nbsp;
                            <v:l key="tx_leseohren.travelOptions.2" />
                        </f:case>
                        <f:case value="3"><i class="bi bi-bicycle"></i>&nbsp;
                            <v:l key="tx_leseohren.travelOptions.3" />
                        </f:case>
                        <f:case value="4"><i class="bi bi-person-walking"></i>&nbsp;
                            <v:l key="tx_leseohren.travelOptions.4" />
                        </f:case>
                        <f:case value="5">
                            <v:l key="tx_leseohren.travelOptions.5" />
                        </f:case>
                        <f:defaultCase></f:defaultCase>
                    </f:switch>
                </div>
                <div class="c-person__preferenceAgegroup">
                    <strong>
                        <v:l key="tx_leseohren.ageGroup" />:
                    </strong> <br />
                    <f:for each="{person.preferenceAgegroup}" as="ageID" iteration="ageIterator">
                        <f:if condition="{ageIterator.isLast}">
                            <f:then>
                                <v:l key="tx_leseohren.ageGroup.{ageID}" />
                            </f:then>
                            <f:else>
                                <v:l key="tx_leseohren.ageGroup.{ageID}" />,
                            </f:else>
                        </f:if>
                    </f:for>
                </div>
                <div class="c-person__preferenceOrganizationType">
                    <strong>
                        <v:l key="tx_leseohren.orgType" />:
                    </strong> <br />
                    <f:for each="{person.preferenceOrganizationType}" as="orgTypeID" iteration="orgTypeIterator">
                        <f:if condition="{orgTypeIterator.isLast}">
                            <f:then>
                                <v:l key="tx_leseohren.orgType.{orgTypeID}" />
                            </f:then>
                            <f:else>
                                <v:l key="tx_leseohren.orgType.{orgTypeID}" />,
                            </f:else>
                        </f:if>
                    </f:for>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Mandat upload -->
<div class="modal fade" id="uploadMandatModal" tabindex="-1" aria-labelledby="uploadMandatModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadMandatModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_mandat" /> hochladen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <f:form action="processFileUpload" name="person" object="{person}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileMandat" class="form-label">
                            <f:translate key="tx_leseohren_domain_model_person.file_mandat" />
                        </label>
                        <f:form.upload property="fileMandat" />
                        <div class="form-text">
                            Erlaubte Dateiformate: PDF, DOC, DOCX, ODT (max. 10MB)
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Hochladen" class="btn btn-primary" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for deleting Mandat -->
<div class="modal fade" id="deleteMandatModal" tabindex="-1" aria-labelledby="deleteMandatModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteMandatModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_mandat" /> löschen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Möchten Sie das Mandat wirklich löschen?</p>
                <f:form action="deleteMandat" name="person" object="{person}">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Löschen" class="btn btn-danger" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for fileFuehrungszeugnis upload -->
<div class="modal fade" id="uploadFuehrungszeugnisModal" tabindex="-1"
    aria-labelledby="uploadFuehrungszeugnisModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadFuehrungszeugnisModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_fuehrungszeugnis" /> hochladen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <f:form action="processFileUpload" name="person" object="{person}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileFuehrungszeugnis" class="form-label">
                            <f:translate key="tx_leseohren_domain_model_person.file_fuehrungszeugnis" />
                        </label>
                        <f:form.upload property="fileFuehrungszeugnis" />
                        <div class="form-text">
                            Erlaubte Dateiformate: PDF, DOC, DOCX, ODT (max. 10MB)
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Hochladen" class="btn btn-primary" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for deleting Führungszeugnis -->
<div class="modal fade" id="deleteFuehrungszeugnisModal" tabindex="-1"
    aria-labelledby="deleteFuehrungszeugnisModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteFuehrungszeugnisModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_fuehrungszeugnis" /> löschen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Möchten Sie das Führungszeugnis wirklich löschen?</p>
                <f:form action="deleteFile" name="person" object="{person}">
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Löschen" class="btn btn-danger" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for editing Führungszeugnis status/date -->
<div class="modal fade" id="editFuehrungszeugnisModal" tabindex="-1" aria-labelledby="editFuehrungszeugnisModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editFuehrungszeugnisModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_fuehrungszeugnis" />
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <f:form action="updateFuehrungszeugnis" name="person" object="{person}">
                    <div class="mb-3 form-check">
                        <f:form.checkbox property="fuehrungszeugnisChecked" id="fzChecked" class="form-check-input"
                            value="1" uncheckedValue="0" checked="{person.fuehrungszeugnisChecked}" />
                        <label class="form-check-label" for="fzChecked">
                            <f:translate key="tx_leseohren_domain_model_person.fuehrungszeugnis_checked" />
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="fzDate" class="form-label">
                            <f:translate key="tx_leseohren_domain_model_person.fuehrungszeugnis_date" />
                        </label>
                        <f:form.textfield property="fuehrungszeugnisDate" id="fzDate"
                            value="{person.fuehrungszeugnisDate -> f:format.date(format: 'd.m.Y')}"
                            class="form-control" />
                        <div class="form-text">Format: TT.MM.JJJJ</div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Speichern" class="btn btn-primary" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for uploading Other Files (multiple) -->
<div class="modal fade" id="uploadOtherFilesModal" tabindex="-1" aria-labelledby="uploadOtherFilesModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadOtherFilesModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_others" /> hochladen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <f:form action="processFileUpload" name="person" object="{person}" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label for="fileOthers" class="form-label">
                            <f:translate key="tx_leseohren_domain_model_person.file_others" />
                        </label>
                        <f:form.upload property="fileOthers" multiple="1" />
                        <div class="form-text">
                            Erlaubte Dateiformate: PDF, DOC, DOCX, ODT (max. 10MB)
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Hochladen" class="btn btn-primary" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<!-- Modal for deleting Other File (reused for any item) -->
<div class="modal fade" id="deleteOtherFileModal" tabindex="-1" aria-labelledby="deleteOtherFileModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteOtherFileModalLabel">
                    <f:translate key="tx_leseohren_domain_model_person.file_others" /> löschen
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Möchten Sie diese Datei wirklich löschen?</p>
                <f:form action="deleteOtherFile" name="person" object="{person}">
                    <f:form.hidden name="fileUid" value="" id="deleteOtherFileUid" />
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Abbrechen</button>
                        <f:form.submit value="Löschen" class="btn btn-danger" />
                    </div>
                </f:form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const uploadModal = document.getElementById('uploadFuehrungszeugnisModal');
        const deleteModal = document.getElementById('deleteFuehrungszeugnisModal');
        const uploadMandatModal = document.getElementById('uploadMandatModal');
        const deleteMandatModal = document.getElementById('deleteMandatModal');

        // New: other files modals
        const uploadOtherModal = document.getElementById('uploadOtherFilesModal');
        const deleteOtherModal = document.getElementById('deleteOtherFileModal');

        // Reset upload form when modal is closed
        if (uploadOtherModal) {
            uploadOtherModal.addEventListener('hidden.bs.modal', function () {
                const form = uploadOtherModal.querySelector('form');
                if (form) {
                    form.reset();
                }
            });
        }

        // When opening deleteOtherFileModal, set hidden input with file uid
        if (deleteOtherModal) {
            deleteOtherModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                if (!button) return;
                const fileUid = button.getAttribute('data-file-uid');
                const input = deleteOtherModal.querySelector('#deleteOtherFileUid');
                if (input && fileUid) {
                    input.value = fileUid;
                }
            });
            // Reset on hide
            deleteOtherModal.addEventListener('hidden.bs.modal', function () {
                const form = deleteOtherModal.querySelector('form');
                if (form) {
                    form.reset();
                }
                const input = deleteOtherModal.querySelector('#deleteOtherFileUid');
                if (input) input.value = '';
            });
        }
    });
</script>
